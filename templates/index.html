<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepfake Detector - AI-Powered Image Analysis</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #2d5a27 0%, #4a7c59 50%, #6b8e23 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; color: white; }
        .header h1 { font-size: 3rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .main-content { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); backdrop-filter: blur(10px); }
        .upload-section { text-align: center; margin-bottom: 24px; }
        .upload-area { border: 3px dashed #4a7c59; border-radius: 15px; padding: 40px 20px; margin: 20px 0; cursor: pointer; transition: all 0.3s ease; background: #f0f8f0; }
        .upload-area:hover { border-color: #6b8e23; background: #e8f5e8; transform: translateY(-2px); }
        .upload-area.dragover { border-color: #28a745; background: #f0fff4; transform: scale(1.02); }
        .upload-icon { font-size: 3.2rem; color: #4a7c59; margin-bottom: 12px; }
        .upload-text { font-size: 1.1rem; color: #666; margin-bottom: 8px; }
        .file-input { display: none; }
        .upload-btn { background: linear-gradient(45deg, #4a7c59, #6b8e23); color: white; border: none; padding: 12px 22px; border-radius: 20px; font-size: 1rem; cursor: pointer; }
        .result-section { display: none; text-align: center; margin-top: 20px; padding: 20px; background: #f0f8f0; border-radius: 12px; }
        .result-image { max-width: 100%; max-height: 360px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.12); margin-bottom: 12px; }
        .tabs { display:flex; gap:8px; justify-content:center; margin-top:18px; flex-wrap:wrap; }
        .tab { padding:8px 14px; border-radius:8px; cursor:pointer; background:#e9f3ea; color:#234; border:1px solid #d6ead5; }
        .tab.active { background:linear-gradient(45deg,#4a7c59,#6b8e23); color:white; }
        .tab-panels { margin-top:18px; }
        .panel { display:none; padding:16px; background:white; border-radius:8px; border:1px solid #e6efe6; }
        .panel.active { display:block; }
        .region-rows { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
        .region-item { display:flex; align-items:center; gap:10px; }
        .region-label { width:140px; font-weight:600; color:#333; }
        .recommendations { text-align:left; margin-top:8px; }
        .small-note { font-size:0.9rem; color:#666; margin-top:6px; }
        .spinner { display:inline-block; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Features cards layout (added) */
        .features {
            display: flex;
            gap: 18px;
            justify-content: space-between;
            align-items: stretch;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .feature-card {
            flex: 1 1 calc(25% - 18px);
            background: #ffffff;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 200px;
            max-width: 280px;
            transition: transform .15s ease, box-shadow .15s ease;
        }
        .feature-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 16px 30px rgba(0,0,0,0.10);
        }
        .feature-icon {
            font-size: 28px;
            color: #4a7c59;
            background: rgba(74,124,89,0.08);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .feature-title {
            font-weight: 700;
            margin-bottom: 8px;
            color: #222;
            font-size: 1.05rem;
        }
        .feature-description {
            color: #555;
            font-size: 0.95rem;
            line-height: 1.3;
        }

        /* Responsive breakpoints */
        @media (max-width: 900px) {
            .feature-card { flex: 1 1 calc(50% - 18px); max-width: none; }
        }
        @media (max-width: 520px) {
            .feature-card { flex: 1 1 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> Deepfake Detector</h1>
            <p>AI-Powered Image Analysis for Detecting Deepfake Images</p>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <h2>Upload an Image for Analysis</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <div class="upload-text">Drop or click to select an image</div>
                    <input type="file" id="fileInput" class="file-input" accept="image/*">
                    <div style="margin-top:12px;">
                        <button class="upload-btn" id="uploadBtn">Choose File</button>
                    </div>
                </div>

                <div class="loading" id="loading" style="display:none;">
                    <div class="spinner" style="border:4px solid #f3f3f3;border-top:4px solid #4a7c59;border-radius:50%;width:36px;height:36px;animation:spin 1s linear infinite;margin:0 auto 12px"></div>
                    <div>Analyzing image with AI...</div>
                </div>
                <div class="error-message" id="errorMessage" style="display:none;"></div>
                <div class="success-message" id="successMessage" style="display:none;"></div>
            </div>

            <div class="result-section" id="resultSection">
                <h3>Analysis Results</h3>

                <div style="display:flex;gap:18px;flex-wrap:wrap;justify-content:center;margin-top:12px;">
                    <div style="max-width:420px;">
                        <div style="text-align:center;margin-bottom:8px;font-weight:600">Original Image</div>
                        <img id="resultImage" class="result-image" alt="Uploaded image">
                    </div>

                    <div style="max-width:420px;">
                        <div style="text-align:center;margin-bottom:8px;font-weight:600">Heatmap / Explanation</div>
                        <img id="heatmapOverlay" class="result-image" alt="Heatmap overlay" src="" style="background:#fff;padding:8px;border-radius:8px;display:none;" />
                        <div id="noHeat" class="small-note" style="display:none;">No heatmap available.</div>
                    </div>
                </div>

                <div style="margin-top:12px;">
                    <div id="predictionResult" class="prediction-result" style="display:inline-block;padding:8px 14px;border-radius:18px;font-weight:700;"></div>
                    <div class="confidence-text" style="margin-top:8px;">Confidence Level</div>
                    <div class="confidence-bar" style="width:100%;max-width:480px;height:18px;background:#e9ecef;border-radius:10px;margin:8px auto;overflow:hidden;">
                        <div class="confidence-fill" id="confidenceFill" style="height:100%;width:0;background:linear-gradient(45deg,#4a7c59,#6b8e23);transition: width 800ms;"></div>
                    </div>
                    <div id="confidenceText" class="small-note"></div>
                </div>

                <div class="tabs" id="tabs" style="display:none;">
                    <div class="tab active" data-panel="panel-heat">Heatmap</div>
                    <div class="tab" data-panel="panel-detailed">Detailed Analysis</div>
                    <div class="tab" data-panel="panel-region">Region Analysis</div>
                    <div class="tab" data-panel="panel-explain">Explanation & Recommendations</div>
                </div>

                <div class="tab-panels" id="tabPanels" style="display:none;">
                    <div id="panel-heat" class="panel active">
                        <div style="text-align:center;">
                            <img id="panelHeatImg" style="max-width:100%;border-radius:8px;border:1px solid #eee;" alt="Heatmap">
                        </div>
                        <div class="small-note" id="heatNote" style="margin-top:8px;"></div>
                    </div>

                    <div id="panel-detailed" class="panel">
                        <h4>Detailed Analysis</h4>
                        <div id="detailedContent" style="min-height:120px;"></div>
                    </div>

                    <div id="panel-region" class="panel">
                        <h4>Region Scores</h4>
                        <div style="max-width:780px;margin:0 auto;">
                            <canvas id="regionChart" style="max-height:320px;"></canvas>
                            <div id="regionRows" class="region-rows"></div>
                        </div>
                    </div>

                    <div id="panel-explain" class="panel">

                        <div style="display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;">
                            <div style="flex:1;min-width:220px;">
                                <div style="font-weight:700;margin-bottom:6px;">Derived Confidence</div>
                                <div id="derivedConfidence" style="font-size:1.4rem;color:#333;">N/A</div>
                                <div style="height:10px;background:#eee;border-radius:6px;margin-top:8px;overflow:hidden;">
                                        <div id="derivedConfidenceBar" style="height:100%;width:0;background:linear-gradient(90deg,#ff6b6b,#ffd600);transition: width 600ms;"></div>
                                    </div>
                            </div>

                            <div style="flex:1;min-width:220px;">
                                <div style="font-weight:700;margin-bottom:6px;">Most Suspicious Region</div>
                                <div id="mostSuspicious" style="font-size:1.05rem;color:#333;">N/A</div>
                                <div id="mostSuspiciousScore" style="color:#666;margin-top:6px;">Score: N/A</div>
                            </div>

                            <div style="flex:1;min-width:200px;">
                                <div style="font-weight:700;margin-bottom:6px;">Final Prediction</div>
                                <div id="predictionFromDerived" style="font-size:1.4rem;font-weight:800;color:#222;">N/A</div>
                                <div id="predictionReason" style="color:#666;margin-top:6px;font-size:0.95rem;">(based on derived confidence)</div>
                            </div>
                        </div>

                        <div style="margin-top:14px;">
                            <div style="font-weight:700;">Explanation</div>
                            <pre id="explainText" style="white-space:pre-wrap;background:#fbfbfb;padding:10px;border-radius:6px;border:1px solid #eee;margin-top:8px;min-height:40px;"></pre>

                            <div style="font-weight:700;margin-top:12px;">Recommendations</div>
                            <div id="recs" class="recommendations" style="margin-top:8px;"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="features">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="feature-title">AI-Powered</div>
                    <div class="feature-description">
                        Advanced deep learning algorithms trained on thousands of real and fake images
                    </div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="feature-title">Fast Analysis</div>
                    <div class="feature-description">
                        Get results in seconds with our optimized neural network architecture
                    </div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="feature-title">Secure</div>
                    <div class="feature-description">
                        Your images are processed locally and never stored permanently
                    </div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div class="feature-title">Mobile Friendly</div>
                    <div class="feature-description">
                        Responsive design that works perfectly on all devices
                    </div>
                </div>
            </div>

        <div class="footer" style="text-align:center;margin-top:18px;color:white;opacity:0.8;">
            <p>&copy; 2025 Deepfake Detector. Powered by AI and Deep Learning.</p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const loading = document.getElementById('loading');
        const resultSection = document.getElementById('resultSection');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const predictionResult = document.getElementById('predictionResult');
        const confidenceFill = document.getElementById('confidenceFill');
        const confidenceText = document.getElementById('confidenceText');
        const resultImage = document.getElementById('resultImage');
        const heatmapOverlay = document.getElementById('heatmapOverlay');
        const noHeat = document.getElementById('noHeat');
        const tabs = document.getElementById('tabs');
        const tabPanels = document.getElementById('tabPanels');
        const panelHeatImg = document.getElementById('panelHeatImg');
        const detailedContent = document.getElementById('detailedContent');
        const regionRows = document.getElementById('regionRows');
        const explainText = document.getElementById('explainText');
        const recs = document.getElementById('recs');

        // Threshold used to interpret numeric confidence as Real vs Fake
        const CONFIDENCE_THRESHOLD = 50;

        let lastFile = null;
        let regionChart = null;

        // click behavior
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadBtn.addEventListener('click', (e) => { e.stopPropagation(); fileInput.click(); });

        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });

        fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

        function handleFile(file) {
            hideFeedback();
            if (!file.type.startsWith('image/')) return showError('Please select a valid image file.');
            if (file.size > 16 * 1024 * 1024) return showError('File size must be less than 16MB.');
            lastFile = file;
            uploadAndAnalyze(file);
        }

        function uploadAndAnalyze(file) {
            const fd = new FormData();
            fd.append('file', file);
            loading.style.display = 'block';
            resultSection.style.display = 'none';
            tabs.style.display = 'none';
            tabPanels.style.display = 'none';
            // clear previous messages
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            fetch('/upload', { method: 'POST', body: fd })
            .then(r => r.json())
            .then(data => {
                loading.style.display = 'none';
                if (!data || !data.success) return showError((data && data.error) || 'Upload failed');
                // populate basic fields from /upload
                if (data.image_data) {
                    resultImage.src = data.image_data && data.image_data.startsWith('data:') ? data.image_data : ('data:image/jpeg;base64,' + data.image_data);
                } else {
                    // preview from local file if server image not provided
                    resultImage.src = URL.createObjectURL(file);
                }
                resultImage.alt = data.filename || 'uploaded';

                // determine confidence and derive status
                const conf = (typeof data.confidence === 'number') ? data.confidence : parseFloat(data.confidence) || 0;
                // show server-provided prediction if available; otherwise derive from numeric confidence
                const serverPrediction = data.prediction || null;
                let uiPrediction = serverPrediction ? serverPrediction : (conf >= CONFIDENCE_THRESHOLD ? 'Real' : 'Fake');

                predictionResult.textContent = "Analyzing...";
                predictionResult.className = `prediction-result ${'prediction-'+uiPrediction.toLowerCase()}`;

                confidenceText.textContent = (conf!==undefined? conf + '%':'');
                confidenceFill.style.width = (conf || 0) + '%';
                resultSection.style.display = 'block';
                // now request explain (use same file)
                requestExplain(lastFile);
            })
            .catch(err => { loading.style.display = 'none'; showError('Network error.'); console.error(err); });
        }

        function requestExplain(file) {
            if (!file) return;
            const fd = new FormData();
            fd.append('file', file);
            loading.style.display = 'block';
            fetch('/explain', { method: 'POST', body: fd })
            .then(r => r.json())
            .then(payload => {
                loading.style.display = 'none';
                if (!payload || !payload.success) {
                    showError((payload && payload.error) || 'Explain failed');
                    return;
                }
                const explain = payload.explanation || payload.explainable_ai || payload;
                populateExplain(explain);
            })
            .catch(err => { loading.style.display = 'none'; showError('Explain API error'); console.error(err); });
        }

        function populateExplain(explain) {
            // Heatmap
            const heatB64 = explain && (explain.heatmap_overlay || explain.heatmap) || null;
            if (heatB64) {
                const src = heatB64.startsWith('data:') ? heatB64 : ('data:image/png;base64,' + heatB64);
                heatmapOverlay.src = src;
                heatmapOverlay.style.display = 'block';
                panelHeatImg.src = src;
                noHeat.style.display = 'none';
            } else {
                heatmapOverlay.style.display = 'none';
                panelHeatImg.src = '';
                noHeat.style.display = 'block';
                noHeat.textContent = 'Heatmap not available for this image.';
            }

            // Detailed analysis (image or HTML or text)
            detailedContent.innerHTML = '';
            if (explain && explain.detailed_analysis) {
                const d = explain.detailed_analysis;
                if (typeof d === 'string' && (d.startsWith('/9') || d.startsWith('iVBOR') || d.startsWith('data:'))) {
                    // base64 image
                    const img = document.createElement('img');
                    img.style.maxWidth = '100%';
                    img.src = d.startsWith('data:') ? d : ('data:image/png;base64,' + d);
                    detailedContent.appendChild(img);
                } else if (typeof d === 'string' && d.trim().startsWith('<')) {
                    detailedContent.innerHTML = d;
                } else {
                    // plain text or object
                    detailedContent.textContent = JSON.stringify(d, null, 2);
                }
            } else {
                detailedContent.textContent = 'No detailed analysis available.';
            }

            // Region analysis - prepare chart and rows
            const regionScores = explain && ((explain.region_analysis && explain.region_analysis.region_scores) || explain.region_scores || explain.regions) || null;
            renderRegionAnalysis(regionScores);

            // Explanation & recommendations
            explainText.innerHTML = '';
            recs.innerHTML = '';
            if (explain && explain.explanation) {
                if (typeof explain.explanation === 'string') explainText.textContent = explain.explanation;
                else if (explain.explanation.summary) explainText.textContent = explain.explanation.summary;
                if (explain.explanation.recommendations && Array.isArray(explain.explanation.recommendations)) {
                    explain.explanation.recommendations.forEach(r => {
                        const li = document.createElement('div');
                        li.textContent = '• ' + r;
                        recs.appendChild(li);
                    });
                }
            } else {
                // fallback fields
                if (explain && explain.recommendations && Array.isArray(explain.recommendations)) {
                    explain.recommendations.forEach(r => {
                        const el = document.createElement('div'); el.textContent = '• ' + r; recs.appendChild(el);
                    });
                }
                if (explain && explain.summary) explainText.textContent = explain.summary;
            }

            // --- compute confVal and mostSusp ---
            let confVal = null;
            if (explain && typeof explain.derived_confidence !== 'undefined' && explain.derived_confidence !== null) {
                confVal = Number(explain.derived_confidence);
            } else if (explain && typeof explain.derived_conf !== 'undefined' && explain.derived_conf !== null) {
                confVal = Number(explain.derived_conf);
            } else if (explain && typeof explain.most_suspicious_score !== 'undefined' && explain.most_suspicious_score !== null) {
                confVal = Number(explain.most_suspicious_score);
            }

            if (confVal !== null && !isNaN(confVal)) {
                if (confVal <= 1.0) confVal = confVal * 100;
                confVal = Math.max(0, Math.min(100, confVal));
            }

            const mostSusp = (explain && (explain.most_suspicious || explain.most_suspicious_region)) ||
                              (explain && explain.region_analysis && explain.region_analysis.most_suspicious) || null;

            // Update Explanation & Recommendations panel elements
            const derivedEl = document.getElementById('derivedConfidence');
            const derivedBar = document.getElementById('derivedConfidenceBar');
            const mostEl = document.getElementById('mostSuspicious');
            const mostScoreEl = document.getElementById('mostSuspiciousScore');
            const predDerivedEl = document.getElementById('predictionFromDerived');
            const explainTextEl = document.getElementById('explainText');
            const recsEl = document.getElementById('recs');

            if (confVal !== null && !isNaN(confVal)) {
                derivedEl.textContent = confVal.toFixed(2) + '%';
                derivedBar.style.width = Math.max(0, Math.min(100, confVal)) + '%';
            } else {
                derivedEl.textContent = 'N/A';
                derivedBar.style.width = '0%';
            }

            if (mostSusp) {
                mostEl.textContent = String(mostSusp);
                const msScore = Number((explain && (explain.most_suspicious_score || explain.most_suspicious_confidence)) || 0);
                const msVal = (msScore <= 1 ? msScore * 100 : msScore) || null;
                mostScoreEl.textContent = msVal ? `Score: ${msVal.toFixed(2)}%` : 'Score: N/A';
            } else {
                mostEl.textContent = 'N/A';
                mostScoreEl.textContent = 'Score: N/A';
            }

            // decide final status based on derived confidence (threshold default 50)
            const threshold = (typeof CONFIDENCE_THRESHOLD !== 'undefined') ? CONFIDENCE_THRESHOLD : 50;
            let status = null;
            if (confVal !== null && !isNaN(confVal)) {
                status = (confVal < threshold) ? 'Fake' : 'Real';
                predDerivedEl.textContent = status;
                // also update main prediction badge
                const mainPred = document.getElementById('predictionResult');
                if (mainPred) {
                    mainPred.textContent = status;
                    mainPred.className = `prediction-result ${'prediction-' + status.toLowerCase()}`;
                }
                // update confidence display too
                const confidenceText = document.getElementById('confidenceText');
                const confidenceFill = document.getElementById('confidenceFill');
                if (confidenceText) confidenceText.textContent = confVal.toFixed(2) + '%';
                if (confidenceFill) confidenceFill.style.width = Math.max(0, Math.min(100, confVal)) + '%';
            }

            // --- NEW: Build human readable explanation line and preserve detail ---
            // prepare summary sentence
            const explainSummaryLine = (confVal !== null && !isNaN(confVal))
                ? `Derived confidence: ${confVal.toFixed(2)}% — Image is ${status || 'N/A'}.`
                : `Derived confidence: N/A — Image is ${status || 'N/A'}.`;

            // place summary at top of Explanation panel, then append the detailed explanation below
            explainTextEl.innerHTML = ''; // clear
            const summaryEl = document.createElement('div');
            summaryEl.style.fontWeight = '700';
            summaryEl.style.marginBottom = '8px';
            summaryEl.textContent = explainSummaryLine;
            explainTextEl.appendChild(summaryEl);

            // append existing explanation body (if any)
                        let explanationText = '';

            explanationText = explainSummaryLine
            //if (explain && explain.explanation) {
                //if (typeof explain.explanation === 'string') explanationText = explain.explanation;
               // else if (explain.explanation.summary) explanationText = explainSummaryLine;
              // else explanationText = explainSummaryLine;
           // } else if (explain && explain.summary) {
               // explanationText = explainSummaryLine;
            //}

            if (explanationText) {
                const bodyPre = document.createElement('pre');
                bodyPre.style.whiteSpace = 'pre-wrap';
                bodyPre.style.margin = '0';
                bodyPre.style.fontWeight = '400';
                bodyPre.textContent = "";
                explainTextEl.appendChild(bodyPre);
            }

            // recommendations rendering remains unchanged
            recsEl.innerHTML = '';
            const recsList = (explain && explain.explanation && explain.explanation.recommendations) || explain.recommendations || [];
            if (Array.isArray(recsList) && recsList.length) {
                recsList.forEach(r => {
                    const d = document.createElement('div'); d.textContent = '• ' + r; recsEl.appendChild(d);
                });
            } else {
                const d = document.createElement('div'); d.textContent = 'No specific recommendations available.'; recsEl.appendChild(d);
            }

            // show tabs
            tabs.style.display = 'flex';
            tabPanels.style.display = 'block';
            activateTab('panel-heat');
        }

        function renderRegionAnalysis(regionScores) {
            regionRows.innerHTML = '';
            const preferredOrder = ['left_eye','right_eye','nose','forehead','left_cheek','right_cheek','cheeks','mouth'];
            const keys = regionScores ? Object.keys(regionScores) : [];
            const orderedKeys = preferredOrder.filter(k => keys.includes(k)).concat(keys.filter(k => !preferredOrder.includes(k)));
            const labels = orderedKeys.map(k => k.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase()));
            const dataVals = orderedKeys.map(k => Math.round((regionScores && regionScores[k] ? regionScores[k] : 0) * 100));

            orderedKeys.forEach((k, i) => {
                const row = document.createElement('div');
                row.className = 'region-item';
                const label = document.createElement('div'); label.className = 'region-label'; label.textContent = labels[i];
                const barWrap = document.createElement('div'); barWrap.style.flex='1'; barWrap.style.background='#f1f1f1'; barWrap.style.borderRadius='8px'; barWrap.style.height='12px'; barWrap.style.overflow='hidden';
                const bar = document.createElement('div'); bar.style.width = dataVals[i] + '%'; bar.style.height='100%'; bar.style.background='linear-gradient(90deg,#ffd600,#ff6b6b)';
                const num = document.createElement('div'); num.style.width='48px'; num.style.textAlign='right'; num.style.fontSize='0.9rem'; num.textContent = dataVals[i] + '%';
                barWrap.appendChild(bar);
                row.appendChild(label); row.appendChild(barWrap); row.appendChild(num);
                regionRows.appendChild(row);
            });

            // Chart.js bar (defensive)
            try {
                const ctx = document.getElementById('regionChart').getContext('2d');
                if (regionChart) regionChart.destroy();
                regionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{ label: 'Suspicion %', data: dataVals, backgroundColor: labels.map(()=> 'rgba(255,99,71,0.8)'), borderRadius:6 }]
                    },
                    options: { responsive:true, scales:{ y:{ beginAtZero:true, max:100 } } }
                });
            } catch (e) {
                console.warn('Region chart render failed:', e);
            }
        }

        // Tabs behavior
        document.querySelectorAll('.tab').forEach(t => {
            t.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
                t.classList.add('active');
                document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
                document.getElementById(t.dataset.panel).classList.add('active');
            });
        });

        function activateTab(panelId) {
            document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
            const tab = Array.from(document.querySelectorAll('.tab')).find(t=>t.dataset.panel===panelId);
            if (tab) tab.classList.add('active');
            document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
            const panel = document.getElementById(panelId);
            if (panel) panel.classList.add('active');
        }

        function showError(msg){ if(!msg) return; errorMessage.textContent = msg; errorMessage.style.display='block'; setTimeout(()=>errorMessage.style.display='none',6000); }
        function showSuccess(msg){ if(!msg) return; successMessage.textContent = msg; successMessage.style.display='block'; setTimeout(()=>successMessage.style.display='none',4000); }
        function hideFeedback(){ errorMessage.style.display='none'; successMessage.style.display='none'; }

    });
    </script>
</body>
</html>
